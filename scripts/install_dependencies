#!/bin/bash

set -e

CATALINA_HOME=/usr/share/tomcat7-codedeploy
TOMCAT_VERSION=7.0.77

# Check if required tools are available
command -v wget >/dev/null 2>&1 || { echo >&2 "wget is required but not installed. Aborting."; exit 1; }
command -v tar >/dev/null 2>&1 || { echo >&2 "tar is required but not installed. Aborting."; exit 1; }

# Check whether Tomcat7 is already installed and running
if systemctl is-active --quiet tomcat7; then
    echo "Tomcat7 is already installed and running. Skip reinstalling it."
    exit 0
fi

# Clear install directory
rm -rf "$CATALINA_HOME"
mkdir -p "$CATALINA_HOME"

# Install libxslt package
sudo yum install -y libxslt || { echo "Failed to install libxslt package"; exit 1; }

# Download the latest Tomcat7 version
cd /tmp
wget -q "$TOMCAT7_CORE_DOWNLOAD_URL"
tar xzf "$TOMCAT7_CORE_TAR_FILENAME"

# Copy Tomcat files to CATALINA_HOME
cp -r "/tmp/$TOMCAT7_CORE_UNPACKED_DIRNAME"/* "$CATALINA_HOME"

# Install Java if not yet installed
command -v java >/dev/null 2>&1 || { sudo yum install -y java; }

# Create the service init.d script
cat > /etc/init.d/tomcat7 <<'EOF'
#!/bin/bash
# description: Tomcat7 Start Stop Restart
# processname: tomcat7
PATH=$JAVA_HOME/bin:$PATH
export PATH
CATALINA_HOME='/usr/share/tomcat7-codedeploy'

case $1 in
start)
sh $CATALINA_HOME/bin/startup.sh
;;
stop)
sh $CATALINA_HOME/bin/shutdown.sh
;;
restart)
sh $CATALINA_HOME/bin/shutdown.sh
sh $CATALINA_HOME/bin/startup.sh
;;
esac
exit 0
EOF

# Change permission mode for the service script
chmod 755 /etc/init.d/tomcat7

# Inform user that installation is complete
echo "Tomcat7 installation completed successfully."
